<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>River ê¸€ë¡œë²Œ ìƒí˜¸ êµë¥˜ í™œì„±í™”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; }
        .box { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 15px; }
        input { background: #0f172a !important; border: 1px solid #475569; border-radius: 8px; padding: 10px; color: white; outline: none; font-size: 14px; }
        .brand-gradient { background: linear-gradient(135deg, #60a5fa 0%, #c084fc 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-grid { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; width: 100%; gap: 1rem; }
        .asset-widget { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(99, 102, 241, 0.4); border-radius: 14px; padding: 10px 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .calc-input { width: 85px !important; text-align: center; background: #0f172a !important; border: 1px solid #475569 !important; border-radius: 6px; }
        .tab-active { background: #4f46e5 !important; color: white !important; font-weight: 900; }
        .daily-log-box { background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 12px; margin-top: 10px; width: 100%; max-width: 300px; }
        .log-row { display: flex; justify-content: space-between; align-items: center; font-size: 11px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .title-text { white-space: nowrap; word-break: keep-all; padding-right: 25px; display: inline-block; }
        .btn-icon { cursor: pointer; transition: opacity 0.2s; font-size: 14px; padding: 4px; }
        .btn-icon:hover { opacity: 0.6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .guide-box { font-size: 11px; color: #94a3b8; line-height: 1.6; border-left: 3px solid #6366f1; padding-left: 10px; }
        .page-btn { background: #334155; color: #94a3b8; padding: 4px 10px; border-radius: 6px; font-size: 12px; }
        .page-btn.active { background: #6366f1; color: white; font-weight: 900; }
    </style>
</head>
<body class="pb-10">

    <nav class="sticky top-0 z-50 bg-slate-900/95 backdrop-blur-md border-b border-slate-800 p-4">
        <div class="max-w-7xl mx-auto nav-grid">
            <div id="clockDisplay" class="flex gap-3 text-[10px] font-bold text-blue-400 font-mono border-r border-slate-700 pr-4"></div>
            
            <div class="text-center overflow-visible">
                <span id="main-title" class="font-black brand-gradient italic text-xl md:text-2xl tracking-tighter title-text">River ê¸€ë¡œë²Œ ìƒí˜¸ êµë¥˜ í™œì„±í™”</span>
            </div>
            
            <div class="flex flex-col items-end">
                <div class="asset-widget flex items-center gap-4">
                    <div class="flex flex-col items-center">
                        <span id="lbl-mypts" class="text-[8px] text-slate-500 font-black uppercase">MY PTS</span>
                        <input id="calcQty" type="number" oninput="runCalculation()" placeholder="0" class="calc-input font-bold text-white">
                    </div>
                    <div class="h-8 w-[1px] bg-slate-700"></div>
                    <div class="flex flex-col items-center px-1">
                        <span id="lbl-price" class="text-[8px] text-indigo-400 font-black uppercase tracking-tighter">PTS PRICE (BNB)</span>
                        <span id="ptsPriceDisplay" class="text-[11px] font-black text-white">$ 0.005527</span>
                    </div>
                    <div class="flex flex-col items-end">
                        <span id="lbl-value" class="text-[8px] text-green-500 font-black uppercase tracking-tighter">BITHUMB USDT VALUE</span>
                        <span id="resKrw" class="text-[14px] font-black text-white">â‚© 0</span>
                        <span id="currentUsdtRate" class="text-[9px] text-slate-500 mt-1 font-mono tracking-tighter">1 USDT = â‚© 0</span>
                    </div>
                </div>
                <div class="daily-log-box">
                    <div class="flex gap-2 mb-2">
                        <input id="dailyPtsInput" type="number" placeholder="ì˜¤ëŠ˜ ìˆ˜ëŸ‰" class="flex-1 bg-transparent border-b border-slate-600 text-[11px] p-1 outline-none text-white">
                        <button onclick="addDailyLogToDB()" id="btnLogAdd" class="bg-indigo-600 px-3 py-1 rounded text-[11px] font-black text-white">ê¸°ë¡</button>
                    </div>
                    <div id="dailyLogList" class="max-h-32 overflow-y-auto no-scrollbar"></div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto p-4 space-y-6">
        <div class="flex justify-end">
            <select id="langSelect" onchange="changeLanguage(this.value)" class="bg-slate-800 text-[11px] text-white rounded px-2 py-1 border border-slate-700 outline-none cursor-pointer">
                <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option><option value="en">ğŸ‡ºğŸ‡¸ English</option>
                <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option><option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option><option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
            </select>
        </div>

        <div class="box border-2 border-indigo-500/20 bg-indigo-900/10 shadow-xl space-y-4">
            <div class="flex gap-2">
                <input id="managerId" type="text" placeholder="ì›í•˜ëŠ” IDë¥¼ ì •í•´ì„œ ì…ë ¥í•˜ì„¸ìš”" class="flex-1 border-indigo-500/40">
                <button onclick="saveAndConnect()" id="btnConnect" class="bg-indigo-600 px-6 rounded-lg font-black text-sm text-white">ì ‘ì†</button>
            </div>
            <div id="guideContent" class="guide-box"></div>
        </div>

        <div class="box bg-slate-800/30 flex gap-2">
            <input id="newMemberName" type="text" placeholder="ìƒˆë¡œìš´ ì´ì›ƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" class="flex-1">
            <button onclick="addNewMember()" class="bg-blue-600 px-6 rounded-lg font-black text-xs text-white">ì¶”ê°€</button>
        </div>

        <div class="flex justify-between gap-1 bg-slate-800/50 p-1 rounded-xl overflow-x-auto no-scrollbar">
            <button onclick="switchCountry('KR')" id="tab-KR" class="flex-1 min-w-[60px] py-3 text-xs rounded-lg text-slate-400 font-black">KR</button>
            <button onclick="switchCountry('US')" id="tab-US" class="flex-1 min-w-[60px] py-3 text-xs rounded-lg text-slate-400 font-black">US</button>
            <button onclick="switchCountry('CN')" id="tab-CN" class="flex-1 min-w-[60px] py-3 text-xs rounded-lg text-slate-400 font-black">CN</button>
            <button onclick="switchCountry('JP')" id="tab-JP" class="flex-1 min-w-[60px] py-3 text-xs rounded-lg text-slate-400 font-black">JP</button>
            <button onclick="switchCountry('VN')" id="tab-VN" class="flex-1 min-w-[60px] py-3 text-xs rounded-lg text-slate-400 font-black">VN</button>
        </div>

        <div class="box p-0 overflow-hidden border-slate-800 shadow-2xl">
            <table class="w-full text-left">
                <tbody id="userTableBody" class="text-sm divide-y divide-slate-800"></tbody>
            </table>
        </div>
        <div id="pagination" class="flex justify-center gap-2 pt-2"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xheuxdsbwcueutukeblm.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_TW6tF_10D5-zv5FdXZE87g_8sNPZmuF'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const PRIVATE_CODE = '2126'; 
        
        let currentCountry = 'KR', currentLang = 'ko', allUsers = [], currentPage = 1;
        const itemsPerPage = 10, timeZones = { KR: 'Asia/Seoul', US: 'America/New_York', CN: 'Asia/Shanghai', JP: 'Asia/Tokyo', VN: 'Asia/Ho_Chi_Minh' };
        let livePtsPrice = 0.005527, usdtKrwRate = 1485;

        const translations = {
            ko: { 
                title: "River ê¸€ë¡œë²Œ ìƒí˜¸ êµë¥˜ í™œì„±í™”", connect: "ì ‘ì†", logBtn: "ê¸°ë¡", logPlace: "ì˜¤ëŠ˜ ìˆ˜ëŸ‰", mypts: "ë‚˜ì˜ PTS", price: "PTS PRICE (BNB)", value: "BITHUMB USDT VALUE",
                guide: "<strong>ğŸ’¡ ì‚¬ìš© ë°©ë²• ì•ˆë‚´:</strong><br>1. <strong>ì ‘ì†</strong> ë²„íŠ¼ í´ë¦­ ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.<br>2. ğŸ”¼/ğŸ”½ í™”ì‚´í‘œë¡œ ëª…ë‹¨ ìˆœìœ„ë¥¼ <strong>í•œ ì¹¸ì”©</strong> ì •í™•í•˜ê²Œ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>3. ì´ì›ƒ ì¶”ê°€ ì‹œ ìˆœìœ„ëŠ” ìë™ìœ¼ë¡œ ê°€ì¥ ë§ˆì§€ë§‰ì— ì„¤ì •ë©ë‹ˆë‹¤."
            },
            en: { 
                title: "River Global Exchange Activation", connect: "Connect", logBtn: "Add", logPlace: "Daily Qty", mypts: "MY PTS", price: "PTS PRICE (BNB)", value: "BITHUMB USDT VALUE",
                guide: "<strong>ğŸ’¡ Instructions:</strong><br>1. A password is required when clicking the <strong>Connect</strong> button.<br>2. Use ğŸ”¼/ğŸ”½ to rank <strong>one step at a time</strong> accurately.<br>3. New members are automatically added to the end of the list."
            },
            zh: { 
                title: "River å…¨çƒç›¸äº’äº¤æµæ¿€æ´»", connect: "è¿æ¥", logBtn: "æäº¤", logPlace: "ä»Šæ—¥æ•°é‡", mypts: "æˆ‘çš„ PTS", price: "PTS ä»·æ ¼ (BNB)", value: "BITHUMB USDT ä»·å€¼",
                guide: "<strong>ğŸ’¡ ä½¿ç”¨æŒ‡å—:</strong><br>1. ç‚¹å‡» <strong>è¿æ¥</strong> æŒ‰é’®æ—¶éœ€è¦è¾“å…¥å¯†ç ã€‚<br>2. ğŸ”¼/ğŸ”½ <strong>é€çº§</strong>å‡†ç¡®è°ƒæ•´é¡ºåºã€‚<br>3. æ·»åŠ æ–°æˆå‘˜æ—¶ï¼Œæ’åå°†è‡ªåŠ¨æ·»åŠ è‡³æœ€åã€‚"
            },
            ja: { 
                title: "River ã‚°ãƒ­ãƒ¼ãƒãƒ«ç›¸äº’äº¤æµã®æ´»æ€§åŒ–", connect: "æ¥ç¶š", logBtn: "ç™»éŒ²", logPlace: "ä»Šæ—¥ã®æ•°é‡", mypts: "ãƒã‚¤ PTS", price: "PTS ä¾¡æ ¼ (BNB)", value: "BITHUMB USDT ä¾¡å€¤",
                guide: "<strong>ğŸ’¡ ä½¿ç”¨ë°©ë²•ã®ã”æ¡ˆå†…:</strong><br>1. <strong>æ¥ç¶š</strong> ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹éš›ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚<br>2. ğŸ”¼/ğŸ”½ ã§é †ä½ã‚’<strong>ä¸€ã¤ãšã¤</strong>æ­£ç¢ºã«èª¿æ•´ã§ãã¾ã™ã€‚<br>3. ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ æ™‚, é †ä½ã¯è‡ªå‹•çš„ã«æœ€å¾Œå°¾ã«ãªã‚Šã¾ã™ã€‚"
            },
            vi: { 
                title: "KÃ­ch hoáº¡t trao Ä‘á»•i toÃ n cáº§u River", connect: "Káº¿t ná»‘i", logBtn: "Gá»­i", logPlace: "Sá»‘ lÆ°á»£ng hÃ´m nay", mypts: "PTS Cá»¦A TÃ”I", price: "GIÃ PTS (BNB)", value: "GIÃ TRá»Š BITHUMB USDT",
                guide: "<strong>ğŸ’¡ HÆ°á»›ng dáº«n sá»­ dá»¥ng:</strong><br>1. Cáº§n nháº­p máº­t kháº©u khi nháº¥n nÃºt <strong>Káº¿t ná»‘i</strong>.<br>2. DÃ¹ng ğŸ”¼/ğŸ”½ Ä‘á»ƒ xáº¿p háº¡ng <strong>tá»«ng bÆ°á»›c</strong> má»™t cÃ¡ch chÃ­nh xÃ¡c.<br>3. ThÃ nh viÃªn má»›i Ä‘Æ°á»£c tá»± Ä‘á»™ng thÃªm vÃ o cuá»‘i."
            }
        };

        async function updateMarketData() {
            try {
                const res = await fetch('https://api.bithumb.com/public/ticker/USDT_KRW');
                const data = await res.json();
                if(data.status === "0000") {
                    usdtKrwRate = parseFloat(data.data.closing_price);
                    document.getElementById('currentUsdtRate').innerText = `1 USDT = â‚© ${usdtKrwRate.toLocaleString()}`;
                    runCalculation();
                }
            } catch(e) {}
        }
        function runCalculation() {
            const qty = parseFloat(document.getElementById('calcQty').value) || 0;
            const total = qty * livePtsPrice * usdtKrwRate;
            document.getElementById('resKrw').innerText = `â‚© ${Math.floor(total).toLocaleString()}`;
        }

        // ğŸ”’ ì ‘ì† ì‹œì—ë§Œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        function saveAndConnect() { 
            const mId = document.getElementById('managerId').value;
            if(!mId) return alert("IDë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            const code = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (code === PRIVATE_CODE) {
                localStorage.setItem('river_manager_id', mId); 
                fetchUsers(); fetchDailyLogs(); 
            } else { alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); }
        }

        // ğŸ“Š ì´ì›ƒ ì¶”ê°€ ì‹œ ìë™ priority ë¶€ì—¬
        async function addNewMember() {
            const mId = document.getElementById('managerId').value;
            const name = document.getElementById('newMemberName').value;
            if(!mId || !name) return alert("ì ‘ì† IDì™€ ì´ë¦„ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");

            const { data } = await supabaseClient.from('river_members').select('priority').eq('manager_id', mId).eq('country', currentCountry).order('priority', { ascending: false }).limit(1);
            const nextPriority = (data && data.length > 0) ? data[0].priority + 1 : 1;

            const { error } = await supabaseClient.from('river_members').insert([{ manager_id: mId, name: name, country: currentCountry, priority: nextPriority }]);
            if(!error) { document.getElementById('newMemberName').value = ''; fetchUsers(); }
        }

        // ğŸ“Š ìˆœìœ„ êµí™˜ ë¡œì§ (í•œ ì¹¸ì”© ì •êµí•œ ì´ë™)
        async function moveMember(globalIndex, direction) {
            const targetIndex = globalIndex + direction;
            if (targetIndex < 0 || targetIndex >= allUsers.length) return;
            const current = allUsers[globalIndex], target = allUsers[targetIndex];
            await supabaseClient.from('river_members').update({ priority: target.priority }).eq('id', current.id);
            await supabaseClient.from('river_members').update({ priority: current.priority }).eq('id', target.id);
            fetchUsers();
        }

        async function editMember(id, oldName) {
            const newName = prompt("ì´ë¦„ì„ ìˆ˜ì •í•˜ì„¸ìš”:", oldName);
            if(newName) { await supabaseClient.from('river_members').update({ name: newName }).eq('id', id); fetchUsers(); }
        }
        async function deleteMember(id) {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await supabaseClient.from('river_members').delete().eq('id', id); fetchUsers(); }
        }

        async function addDailyLogToDB() {
            const mId = document.getElementById('managerId').value;
            const qty = document.getElementById('dailyPtsInput').value;
            if(!mId || !qty) return;
            await supabaseClient.from('river_daily_logs').insert([{ manager_id: mId, amount: parseInt(qty) }]);
            document.getElementById('dailyPtsInput').value = ''; fetchDailyLogs();
        }
        async function editLog(id, oldVal) {
            const newVal = prompt("ìˆ˜ì •í•  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”:", oldVal);
            if(newVal !== null && newVal !== "") {
                await supabaseClient.from('river_daily_logs').update({ amount: parseInt(newVal) }).eq('id', id);
                fetchDailyLogs();
            }
        }
        async function deleteLog(id) {
            if(confirm("ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await supabaseClient.from('river_daily_logs').delete().eq('id', id); fetchDailyLogs();
            }
        }
        async function fetchDailyLogs() {
            const mId = document.getElementById('managerId').value;
            if(!mId) return;
            const { data } = await supabaseClient.from('river_daily_logs').select('*').eq('manager_id', mId).order('created_at', { ascending: false }).limit(10);
            const list = document.getElementById('dailyLogList');
            list.innerHTML = (data || []).map(l => {
                const d = new Date(l.created_at);
                return `<div class="log-row"><div>ğŸ—“ï¸ ${d.getMonth()+1}/${d.getDate()} <span class="font-bold text-indigo-400 ml-2">${l.amount.toLocaleString()} Pts</span></div><div class="flex gap-4"><span onclick="editLog(${l.id}, ${l.amount})" class="btn-icon">âœï¸</span><span onclick="deleteLog(${l.id})" class="btn-icon">âŒ</span></div></div>`;
            }).join('');
        }

        async function fetchUsers() {
            const mId = document.getElementById('managerId').value;
            if(!mId) return;
            const { data } = await supabaseClient.from('river_members').select('*').eq('manager_id', mId).eq('country', currentCountry).order('priority', { ascending: false });
            allUsers = data || []; renderTable();
        }

        function renderTable() {
            const body = document.getElementById('userTableBody'); body.innerHTML = '';
            const totalPages = Math.ceil(allUsers.length / itemsPerPage);
            const start = (currentPage - 1) * itemsPerPage;
            const pageData = allUsers.slice(start, start + itemsPerPage);
            pageData.forEach((u, i) => {
                const globalIdx = start + i;
                const row = document.createElement('tr');
                row.innerHTML = `<td class="p-4 flex justify-between items-center"><div><span class="text-indigo-400 font-black mr-2">#${globalIdx + 1}</span><strong>${u.name}</strong></div><div class="flex gap-4 text-xl"><span onclick="moveMember(${globalIdx}, -1)" class="btn-icon text-blue-400">ğŸ”¼</span><span onclick="moveMember(${globalIdx}, 1)" class="btn-icon text-blue-400">ğŸ”½</span><span onclick="editMember(${u.id}, '${u.name}')" class="btn-icon text-orange-400 text-sm">âœï¸</span><span onclick="deleteMember(${u.id})" class="btn-icon text-red-500 text-sm">âŒ</span></div></td>`;
                body.appendChild(row);
            });
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const div = document.getElementById('pagination'); div.innerHTML = '';
            if (totalPages <= 1) return;
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.innerText = i; btn.className = `page-btn ${currentPage === i ? 'active' : ''} mx-1`;
                btn.onclick = () => { currentPage = i; renderTable(); }; div.appendChild(btn);
            }
        }

        function changeLanguage(lang) {
            currentLang = lang; const t = translations[lang] || translations.ko;
            document.getElementById('main-title').innerText = t.title;
            document.getElementById('btnConnect').innerText = t.connect;
            document.getElementById('btnLogAdd').innerText = t.logBtn;
            document.getElementById('dailyPtsInput').placeholder = t.logPlace;
            document.getElementById('lbl-mypts').innerText = t.mypts;
            document.getElementById('lbl-price').innerText = t.price;
            document.getElementById('lbl-value').innerText = t.value;
            document.getElementById('guideContent').innerHTML = t.guide;
            fetchDailyLogs();
        }

        function switchCountry(code) { 
            currentCountry = code; currentPage = 1;
            document.querySelectorAll('[onclick^="switchCountry"]').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`tab-${code}`).classList.add('tab-active');
            fetchUsers(); 
        }

        window.onload = () => {
            updateMarketData(); setInterval(updateMarketData, 60000);
            const savedId = localStorage.getItem('river_manager_id');
            if(savedId) document.getElementById('managerId').value = savedId;
            changeLanguage(currentLang);
            if(savedId) { fetchUsers(); fetchDailyLogs(); }
            switchCountry('KR');
            setInterval(() => {
                const html = Object.keys(timeZones).map(code => {
                    const time = new Date().toLocaleTimeString('en-US', { timeZone: timeZones[code], hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                    return `<div class="flex flex-col items-center min-w-[40px]"><span>${code}</span><span>${time}</span></div>`;
                }).join('');
                document.getElementById('clockDisplay').innerHTML = html;
            }, 1000);
        };
    </script>
</body>
</html>
